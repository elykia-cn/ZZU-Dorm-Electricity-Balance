<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>宿舍电量监控</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://registry.npmmirror.com/echarts/5.6.0/files/dist/echarts.min.js"></script>
  <style>
    #main-container { width: 95%; margin: auto; }
    .chart-container { width: 100%; height: 400px; margin: 20px 0; }
  </style>
</head>
<body>
<div id="main-container">
  <h1>宿舍电量监控</h1>
  <div id="select-box">
    <label for="timeSplit">选择时间段:</label>
    <select id="timeSplit" onchange="updateCharts()">
      <option value="last_30_records">最近30条记录</option>
    </select>
  </div>
  <div id="chart-lt" class="chart-container"></div>
  <div id="chart-ac" class="chart-container"></div>
</div>

<script>
  const chartLt = echarts.init(document.getElementById('chart-lt'));
  const chartAc = echarts.init(document.getElementById('chart-ac'));

  function getBaseOption(title) {
    return {
      title: { text: title, left: 'center' },
      tooltip: {
        trigger: 'axis',
        formatter: params => {
          const date = new Date(params[0].value[0]);
          const timeStr = date.toLocaleString('zh-CN', {
            month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });
          return params
            .filter(p => p.seriesName === "原始数据")
            .map(p => `${timeStr}<br/>${p.seriesName}: ${p.value[1].toFixed(2)} kWh`)
            .join("<br/>");
        }
      },
      xAxis: { type: 'time' },
      yAxis: { type: 'value', name: '电量 (kWh)' },
      series: [
        { 
          name: '原始数据',
          type: 'line',
          showSymbol: true,
          symbolSize: 6,
          connectNulls: false,
          data: []
        },
        {
          name: '平滑曲线',
          type: 'line',
          showSymbol: false,
          lineStyle: { width: 2, opacity: 0.7 },
          tooltip: { show: false },
          data: []
        }
      ],
      dataZoom: [
        { type: 'slider', xAxisIndex: 0 }, 
        { type: 'inside', xAxisIndex: 0 }
      ]
    };
  }

  chartLt.setOption(getBaseOption('照明电量变化'));
  chartAc.setOption(getBaseOption('空调电量变化'));

  // ========== 更完整的 Akima 样条算法 ==========
  function akimaSpline(x, y, resolution = 10) {
    const n = x.length;
    if (n < 5) return x.map((xi, i) => [xi, y[i]]);

    // step 1: 计算斜率 m
    const m = new Array(n + 3);
    for (let i = -2; i < n + 2; i++) {
      if (i < 0) {
        m[i + 2] = (y[1] - y[0]) / (x[1] - x[0]);
      } else if (i >= n - 1) {
        m[i + 2] = (y[n-1] - y[n-2]) / (x[n-1] - x[n-2]);
      } else {
        m[i + 2] = (y[i+1] - y[i]) / (x[i+1] - x[i]);
      }
    }

    // step 2: 计算权重并得到导数 t
    const t = new Array(n);
    for (let i = 0; i < n; i++) {
      const w1 = Math.abs(m[i+3] - m[i+2]);
      const w2 = Math.abs(m[i+1] - m[i]);
      if (w1 + w2 === 0) {
        t[i] = (m[i+1] + m[i+2]) / 2;
      } else {
        t[i] = (w1 * m[i+1] + w2 * m[i+2]) / (w1 + w2);
      }
    }

    // step 3: 构造分段多项式并插值
    const result = [];
    for (let i = 0; i < n - 1; i++) {
      const h = x[i+1] - x[i];
      const a = y[i];
      const b = t[i];
      const c = (3*(y[i+1]-y[i])/h - 2*t[i] - t[i+1]) / h;
      const d = (2*(y[i]-y[i+1])/h + t[i] + t[i+1]) / (h*h);

      for (let j = 0; j <= resolution; j++) {
        const u = j / resolution;
        const xx = x[i] + u * h;
        const yy = a + b*(u*h) + c*(u*h)*(u*h) + d*(u*h)*(u*h)*(u*h);
        result.push([xx, yy]);
      }
    }
    return result;
  }

  // ========== 数据处理 ==========
  function fetchData(path) {
    return fetch(path).then(r => r.json());
  }

  function setupCharts(data) {
    const currentYear = new Date().getFullYear();
    const processed = data.map(d => {
      const ts = new Date(`${currentYear}-${d.time}`).getTime();
      return { ...d, timestamp: ts };
    }).sort((a,b) => a.timestamp - b.timestamp);

    const ltRaw = processed.map(d => [d.timestamp, d.lt_Balance]);
    const acRaw = processed.map(d => [d.timestamp, d.ac_Balance]);

    const ltSmooth = akimaSpline(
      processed.map(d => d.timestamp),
      processed.map(d => d.lt_Balance),
      8
    );
    const acSmooth = akimaSpline(
      processed.map(d => d.timestamp),
      processed.map(d => d.ac_Balance),
      8
    );

    chartLt.setOption({
      series: [
        { data: ltRaw },
        { data: ltSmooth }
      ]
    });
    chartAc.setOption({
      series: [
        { data: acRaw },
        { data: acSmooth }
      ]
    });
  }

  function updateCharts() {
    const val = document.getElementById('timeSplit').value;
    fetchData(`./data/${val}.json`).then(setupCharts);
  }

  // 初始化
  fetchData('./data/time.json').then(timeData => {
    const sel = document.getElementById('timeSplit');
    timeData.forEach(t => {
      const o = document.createElement('option');
      o.value = t; o.text = t;
      sel.add(o);
    });
    if (timeData.length > 0) updateCharts();
  });
</script>
</body>
</html>