<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>宿舍电量监控</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://registry.npmmirror.com/echarts/5.6.0/files/dist/echarts.min.js"></script>
  <style>
    #main-container { width: 95%; margin: auto; }
    .chart-container { width: 100%; height: 400px; margin: 20px 0; }
  </style>
</head>
<body>
<div id="main-container">
  <h1>宿舍电量监控</h1>
  <div id="select-box">
    <label for="timeSplit">选择时间段:</label>
    <select id="timeSplit" onchange="updateCharts()">
      <option value="last_30_records">最近30条记录</option>
    </select>
  </div>
  <div id="chart-lt" class="chart-container"></div>
  <div id="chart-ac" class="chart-container"></div>
</div>

<script>
  const chartLt = echarts.init(document.getElementById('chart-lt'));
  const chartAc = echarts.init(document.getElementById('chart-ac'));

  function getBaseOption(title) {
    return {
      title: { text: title, left: 'center' },
      tooltip: {
        trigger: 'axis',
        formatter: params => {
          const date = new Date(params[0].value[0]);
          const timeStr = date.toLocaleString('zh-CN', {
            month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });
          return params.map(p => 
            `${timeStr}<br/>${p.seriesName}: ${p.value[1].toFixed(2)} kWh`
          ).join("<br/>");
        }
      },
      xAxis: { type: 'time' },
      yAxis: { type: 'value', name: '电量 (kWh)' },
      series: [
        { 
          name: '原始数据',
          type: 'line',
          showSymbol: true,
          symbolSize: 6,
          connectNulls: false,
          data: []
        },
        {
          name: '平滑曲线',
          type: 'line',
          showSymbol: false,
          lineStyle: { width: 2, opacity: 0.7 },
          tooltip: { show: false }, // 不显示插值点 tooltip
          data: []
        }
      ],
      dataZoom: [
        { type: 'slider', xAxisIndex: 0 }, 
        { type: 'inside', xAxisIndex: 0 }
      ]
    };
  }

  chartLt.setOption(getBaseOption('照明电量变化'));
  chartAc.setOption(getBaseOption('空调电量变化'));

  // ========== Akima 样条算法 ==========
  function akimaInterpolation(x, y, step = 5) {
    if (x.length < 5) return x.map((xi, i) => [xi, y[i]]);

    const m = [], t = [];
    for (let i = 0; i < x.length - 1; i++) {
      m.push((y[i+1] - y[i]) / (x[i+1] - x[i]));
    }
    // 处理边界
    m.unshift(2*m[0] - m[1]);
    m.unshift(2*m[0] - m[1]);
    m.push(2*m[m.length-1] - m[m.length-2]);
    m.push(2*m[m.length-1] - m[m.length-2]);

    // 权重计算
    for (let i = 2; i < m.length - 2; i++) {
      const w1 = Math.abs(m[i+1] - m[i]);
      const w2 = Math.abs(m[i-1] - m[i-2]);
      if (w1 + w2 === 0) t[i-2] = (m[i-1] + m[i]) / 2;
      else t[i-2] = (w1 * m[i-1] + w2 * m[i]) / (w1 + w2);
    }

    const result = [];
    for (let i = 0; i < x.length - 1; i++) {
      const xi = x[i], xi1 = x[i+1];
      const yi = y[i], yi1 = y[i+1];
      const ti = t[i], ti1 = t[i+1];
      const h = xi1 - xi;
      for (let s = 0; s <= step; s++) {
        const u = s / step;
        const h00 = (1+2*u)*(1-u)*(1-u);
        const h10 = u*(1-u)*(1-u);
        const h01 = u*u*(3-2*u);
        const h11 = u*u*(u-1);
        const yy = h00*yi + h10*h*ti + h01*yi1 + h11*h*ti1;
        const xx = xi + u*h;
        result.push([xx, yy]);
      }
    }
    return result;
  }

  // ========== 数据处理 ==========
  function fetchData(path) {
    return fetch(path).then(r => r.json());
  }

  function setupCharts(data) {
    const currentYear = new Date().getFullYear();
    const processed = data.map(d => {
      const ts = new Date(`${currentYear}-${d.time}`).getTime();
      return { ...d, timestamp: ts };
    }).sort((a,b) => a.timestamp - b.timestamp);

    const ltRaw = processed.map(d => [d.timestamp, d.lt_Balance]);
    const acRaw = processed.map(d => [d.timestamp, d.ac_Balance]);

    const ltSmooth = akimaInterpolation(
      processed.map(d => d.timestamp),
      processed.map(d => d.lt_Balance)
    );
    const acSmooth = akimaInterpolation(
      processed.map(d => d.timestamp),
      processed.map(d => d.ac_Balance)
    );

    chartLt.setOption({
      series: [
        { data: ltRaw },
        { data: ltSmooth }
      ]
    });
    chartAc.setOption({
      series: [
        { data: acRaw },
        { data: acSmooth }
      ]
    });
  }

  function updateCharts() {
    const val = document.getElementById('timeSplit').value;
    fetchData(`./data/${val}.json`).then(setupCharts);
  }

  // 初始化
  fetchData('./data/time.json').then(timeData => {
    const sel = document.getElementById('timeSplit');
    timeData.forEach(t => {
      const o = document.createElement('option');
      o.value = t; o.text = t;
      sel.add(o);
    });
    if (timeData.length > 0) updateCharts();
  });
</script>
</body>
</html>
