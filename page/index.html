<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>宿舍电量监控</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="https://registry.npmmirror.com/echarts/5.6.0/files/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="./style.css">
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
</head>

<body>
    <div id="main-container">
        <h1>宿舍电量监控</h1>
        <div id="select-box">
            <label for="timeSplit">选择时间段:</label>
            <select id="timeSplit" onchange="updateChart()">
                <option value="last_30_records">最近30条记录</option>
                <!-- Options will be dynamically added here -->
            </select>
        </div>
        <div id="chart-container" class="chart-container"></div>
    </div>

    <script>
        const chartDom = document.getElementById('chart-container');
        const myChart = echarts.init(chartDom);

        // 配置项
        let option = {
            title: {
                text: '宿舍电量变化',
                textStyle: { fontSize: 20, fontWeight: 'bold' },
                x: 'center',
                y: 'top'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' },
                formatter: function (params) {
                    const date = new Date(params[0].value[0]);
                    const timeStr = date.toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    let result = timeStr + '<br/>';
                    params.forEach(function (item) {
                        result += item.marker + ' ' + item.seriesName + ': ' + item.value[1] + ' kWh<br/>';
                    });
                    return result;
                }
            },
            legend: {
                data: ['照明电量', '空调电量'],
                bottom: 10
            },
            xAxis: {
                type: 'time',
                name: '时间',
                nameLocation: 'end',
                axisLabel: {
                    formatter: function (value) {
                        const date = new Date(value);
                        return date.toLocaleString('zh-CN', {
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                }
            },
            yAxis: {
                type: 'value',
                name: '电量 (kWh)'
            },
            series: [
                {
                    name: '照明电量',
                    type: 'line',
                    showSymbol: true,
                    symbolSize: 8,
                    data: [],
                    markPoint: {
                        data: [
                            { type: 'max', name: '最大值' },
                            { type: 'min', name: '最小值' }
                        ]
                    }
                },
                {
                    name: '空调电量',
                    type: 'line',
                    showSymbol: true,
                    symbolSize: 8,
                    data: [],
                    markPoint: {
                        data: [
                            { type: 'max', name: '最大值' },
                            { type: 'min', name: '最小值' }
                        ]
                    }
                }
            ],
            dataZoom: [
                {
                    type: 'slider',
                    xAxisIndex: 0,
                    start: 0,
                    end: 100
                },
                {
                    type: 'inside',
                    xAxisIndex: 0,
                    start: 0,
                    end: 100
                }
            ]
        };

        // 应用配置
        myChart.setOption(option);

        // 窗口大小变化时重绘图表
        window.addEventListener('resize', function() {
            myChart.resize();
        });

        function fetchData(dataFilepath) {
            return fetch(dataFilepath)
                .then(response => response.json())
                .catch(error => { 
                    console.error('加载JSON错误:', error); 
                    throw error; 
                });
        }

        function setupCharts(jsonData) {
            // 转换时间格式为时间戳
            const currentYear = new Date().getFullYear();
            const data = jsonData.map(entry => {
                // 将时间字符串转换为完整的时间字符串，然后转换为时间戳
                const fullTimeStr = `${currentYear}-${entry.time}`;
                const timestamp = new Date(fullTimeStr).getTime();
                return {
                    ...entry,
                    timestamp: timestamp
                };
            });

            // 按时间戳排序
            data.sort((a, b) => a.timestamp - b.timestamp);

            // 准备图表数据
            const ltData = data.map(entry => [entry.timestamp, entry.lt_Balance]);
            const acData = data.map(entry => [entry.timestamp, entry.ac_Balance]);

            // 更新图表
            option.series[0].data = ltData;
            option.series[1].data = acData;
            myChart.setOption(option);
        }

        function updateChart() {
            const selectedYearMonth = document.getElementById('timeSplit').value;
            const dataFilepath = `./data/${selectedYearMonth}.json`;
            fetchData(dataFilepath)
                .then(jsonData => { setupCharts(jsonData); })
                .catch(error => console.error('图表设置错误:', error));
        }

        // 初始化时间选择器
        fetchData('./data/time.json').then(timeData => {
            const selectBox = document.getElementById('timeSplit');
            timeData.forEach(yearMonth => {
                const optionElement = document.createElement('option');
                optionElement.value = yearMonth;
                optionElement.text = yearMonth;
                selectBox.add(optionElement);
            });

            updateChart();
        }).catch(error => console.error('加载时间数据错误:', error));
    </script>
</body>

</html>
