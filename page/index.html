<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>宿舍电量监控</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="https://registry.npmmirror.com/echarts/5.6.0/files/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="./style.css">
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
</head>

<body>
    <div id="main-container">
        <h1>宿舍电量监控</h1>
        <div id="select-box">
            <label for="timeSplit">选择时间段:</label>
            <select id="timeSplit" onchange="updateChart()">
                <option value="last_30_records">最近30条记录</option>
            </select>
        </div>
        <div id="chart-container" class="chart-container"></div>
    </div>

    <script>
        const chartDom = document.getElementById('chart-container');
        const myChart = echarts.init(chartDom);

        let option = {
            title: {
                text: '宿舍电量变化',
                textStyle: { fontSize: 20, fontWeight: 'bold' },
                x: 'center',
                y: 'top'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' },
                formatter: function (params) {
                    const date = new Date(params[0].value[0]);
                    const timeStr = date.toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    let result = timeStr + '<br/>';
                    params.forEach(function (item) {
                        result += item.marker + ' ' + item.seriesName + ': ' + item.value[1].toFixed(2) + ' kWh<br/>';
                    });
                    return result;
                }
            },
            legend: {
                data: ['照明电量', '空调电量'],
                bottom: 10
            },
            xAxis: {
                type: 'time',
                name: '时间',
                axisLabel: {
                    formatter: function (value) {
                        const date = new Date(value);
                        return date.toLocaleString('zh-CN', {
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                }
            },
            yAxis: {
                type: 'value',
                name: '电量 (kWh)'
            },
            series: [
                { name: '照明电量', type: 'line', smooth: true, showSymbol: false, data: [] },
                { name: '空调电量', type: 'line', smooth: true, showSymbol: false, data: [] }
            ],
            dataZoom: [
                { type: 'slider', xAxisIndex: 0, start: 0, end: 100 },
                { type: 'inside', xAxisIndex: 0, start: 0, end: 100 }
            ]
        };
        myChart.setOption(option);

        window.addEventListener('resize', () => myChart.resize());

        // ------------------ 工具函数 ------------------

        // 填充缺失值
        function interpolateMissingData(dataArray) {
            const processedData = [...dataArray];
            ['lt_Balance', 'ac_Balance'].forEach(field => {
                for (let i = 0; i < processedData.length; i++) {
                    if (processedData[i][field] == null) {
                        let prevIndex = i - 1;
                        while (prevIndex >= 0 && processedData[prevIndex][field] == null) prevIndex--;
                        let nextIndex = i + 1;
                        while (nextIndex < processedData.length && processedData[nextIndex][field] == null) nextIndex++;
                        if (prevIndex >= 0 && nextIndex < processedData.length) {
                            const prevVal = processedData[prevIndex][field];
                            const nextVal = processedData[nextIndex][field];
                            const numSteps = nextIndex - prevIndex;
                            const stepVal = (nextVal - prevVal) / numSteps;
                            processedData[i][field] = prevVal + stepVal * (i - prevIndex);
                        } else if (prevIndex >= 0) {
                            processedData[i][field] = processedData[prevIndex][field];
                        } else if (nextIndex < processedData.length) {
                            processedData[i][field] = processedData[nextIndex][field];
                        } else {
                            processedData[i][field] = 0;
                        }
                    }
                }
            });
            return processedData;
        }

        // 三次样条插值
        function cubicSplineInterpolate(xs, ys, numPoints = 10) {
            const n = xs.length;
            if (n < 3) return xs.map((x, i) => [x, ys[i]]);
            const h = new Array(n - 1);
            for (let i = 0; i < n - 1; i++) h[i] = xs[i + 1] - xs[i];
            const alpha = new Array(n).fill(0);
            for (let i = 1; i < n - 1; i++) {
                alpha[i] = (3 / h[i]) * (ys[i + 1] - ys[i]) - (3 / h[i - 1]) * (ys[i] - ys[i - 1]);
            }
            const l = new Array(n).fill(1);
            const mu = new Array(n).fill(0);
            const z = new Array(n).fill(0);
            for (let i = 1; i < n - 1; i++) {
                l[i] = 2 * (xs[i + 1] - xs[i - 1]) - h[i - 1] * mu[i - 1];
                mu[i] = h[i] / l[i];
                z[i] = (alpha[i] - h[i - 1] * z[i - 1]) / l[i];
            }
            const b = new Array(n - 1);
            const c = new Array(n).fill(0);
            const d = new Array(n - 1);
            for (let j = n - 2; j >= 0; j--) {
                c[j] = z[j] - mu[j] * c[j + 1];
                b[j] = (ys[j + 1] - ys[j]) / h[j] - h[j] * (c[j + 1] + 2 * c[j]) / 3;
                d[j] = (c[j + 1] - c[j]) / (3 * h[j]);
            }
            const result = [];
            for (let i = 0; i < n - 1; i++) {
                const step = (xs[i + 1] - xs[i]) / numPoints;
                for (let k = 0; k <= numPoints; k++) {
                    const x = xs[i] + k * step;
                    const dx = x - xs[i];
                    const y = ys[i] + b[i] * dx + c[i] * dx * dx + d[i] * dx * dx * dx;
                    result.push([x, y]);
                }
            }
            return result;
        }

        // 加载数据文件
        function fetchData(dataFilepath) {
            return fetch(dataFilepath).then(r => r.json());
        }

        // 设置图表
        function setupCharts(jsonData) {
            const filledData = interpolateMissingData(jsonData);
            const currentYear = new Date().getFullYear();
            const data = filledData.map(entry => {
                return {
                    ...entry,
                    timestamp: new Date(`${currentYear}-${entry.time}`).getTime()
                };
            }).sort((a, b) => a.timestamp - b.timestamp);

            const xs = data.map(e => e.timestamp);
            const ys_lt = data.map(e => e.lt_Balance);
            const ys_ac = data.map(e => e.ac_Balance);

            // 样条插值
            const ltData = cubicSplineInterpolate(xs, ys_lt, 20);
            const acData = cubicSplineInterpolate(xs, ys_ac, 20);

            option.series[0].data = ltData;
            option.series[1].data = acData;
            myChart.setOption(option);
        }

        function updateChart() {
            const selectedYearMonth = document.getElementById('timeSplit').value;
            const dataFilepath = `./data/${selectedYearMonth}.json`;
            fetchData(dataFilepath)
                .then(jsonData => setupCharts(jsonData))
                .catch(err => console.error('图表设置错误:', err));
        }

        // 初始化时间选择器
        fetchData('./data/time.json').then(timeData => {
            const selectBox = document.getElementById('timeSplit');
            timeData.forEach(yearMonth => {
                const opt = document.createElement('option');
                opt.value = yearMonth;
                opt.text = yearMonth;
                selectBox.add(opt);
            });
            if (timeData.length > 0) updateChart();
        });
    </script>
</body>
</html>